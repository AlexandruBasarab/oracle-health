window.ASCVDRisk=window.ASCVDRisk||{},(()=>{const e={},t={};e.ret=$.Deferred();e.setDefaultPatient=()=>{t.firstName=void 0,t.lastName=void 0,t.gender=void 0,t.dateOfBirth=void 0,t.age=21;const a={smoker:void 0,race:void 0,hypertensive:void 0,diabetic:void 0};t.relatedFactors=a,t.totalCholesterol=void 0,t.hdl=void 0,t.systolicBloodPressure=void 0,e.hideDemoBanner=!0,e.ret.resolve(t)};e.initializeLogger=()=>{apex.debug.setLevel(apex.debug.LOG_LEVEL.APP_TRACE)};e.onError=()=>{apex.debug.error("Authorization error while loading the application."),e.ret.reject()},e.onReady=async function(a){const o=new Date,r=new Date;if(r.setFullYear(o.getFullYear()-1),{}.hasOwnProperty.call(a,"patient")){let o=a.patient.read();const i=new URLSearchParams;i.set("patient",a.patient.id),i.set("_count",5),i.set("date",`gt${r.toJSON()}`),i.set("code",["http://loinc.org|14647-2","http://loinc.org|2093-3","http://loinc.org|2085-9","http://loinc.org|8480-6","http://loinc.org|55284-4","http://loinc.org|72166-2","http://snomed.info/sct|229819007"].join(","));let s=a.request("Observation?"+i,{pageLimit:0,flat:!0});Promise.all([o,s]).then((([o,r])=>{t.firstName=o.name[0].given.join(" "),t.lastName=o.name[0].family,t.gender=o.gender,t.dateOfBirth=new Date(o.birthDate.replace(/-/g,"/")),t.age=e.computeAgeFromBirthDate(new Date(t.dateOfBirth.valueOf()));const i={smoker:void 0,race:void 0,hypertensive:void 0,diabetic:void 0};t.relatedFactors=i;const s=a.byCodes(r,"code");if(e.processLabsData(s),e.areRequiredLabsNotAvailable()){let t="";if(e.hasObservationWithUnsupportedUnits)({}).hasOwnProperty.call(e.unsupportedUnitDataPoint,"code")&&(t=e.unsupportedUnitDataPoint.code.text),apex.debug.error("Unsupported unit of measure, Observation :",{status:e.unsupportedUnitDataPoint.status,value:e.unsupportedUnitDataPoint.valueQuantity.value,unit:e.unsupportedUnitDataPoint.valueQuantity.unit,valueString:e.unsupportedUnitDataPoint.valueString,codeText:t});else if(e.unsupportedObservationStructureDataPoint){let a="",o="";({}).hasOwnProperty.call(e.unsupportedObservationStructureDataPoint,"code")&&(t=e.unsupportedObservationStructureDataPoint.code.text),{}.hasOwnProperty.call(e.unsupportedObservationStructureDataPoint,"valueQuantity")&&(a=e.unsupportedObservationStructureDataPoint.valueQuantity.value,o=e.unsupportedObservationStructureDataPoint.valueQuantity.unit),apex.debug.error("Unsupported Observation structure, Observation :",{status:e.unsupportedObservationStructureDataPoint.status,value:a,unit:o,valueString:e.unsupportedObservationStructureDataPoint.valueString,codeText:t})}}e.ret.resolve(t)})).catch((t=>{apex.debug.error("Patient or Observations resource failed",t),e.setDefaultPatient()}))}else apex.debug.error("Patient resource failure while loading the application."),apex.message.clearErrors(),apex.message.showErrors([{type:"error",location:"page",message:"Patient resource failure while loading the application.",unsafe:!1}]),e.setDefaultPatient()};e.fetchPatientData=()=>(FHIR.oauth2.ready().then(e.onReady).catch(e.onError),e.ret.promise());e.computeAgeFromBirthDate=e=>{const t=new Date;let a=t.getFullYear()-e.getFullYear();e.setFullYear(e.getFullYear()+a),e>t&&(a-=1,e.setFullYear(e.getFullYear()-1));const o=(t.getTime()-e.getTime())/864e5;return Math.floor(a+o/(r=t.getFullYear(),1===new Date(r,1,29).getMonth()?366:365));var r};e.computeBirthDateFromAge=t=>{const a=(new Date).getFullYear()-t,o=e.patientInfo.dateOfBirth.getMonth(),r=e.patientInfo.dateOfBirth.getDate(),i=new Date(a,o,r),s=e.computeAgeFromBirthDate(new Date(i.valueOf()));return s===t?i:s<t?new Date(a-1,o,r):new Date(a+1,o,r)};e.processLabsData=a=>{e.hasObservationWithUnsupportedUnits=!1,t.totalCholesterol=e.getCholesterolValue(a("14647-2","2093-3")),t.hdl=e.getCholesterolValue(a("2085-9")),t.systolicBloodPressure=e.getSystolicBloodPressureValue(a("55284-4")),t.relatedFactors.smoker=e.getSmokerStatus(a("72166-2","229819007"))};e.getSmokerStatus=e=>{const t=e.sort(((e,t)=>Date.parse(t.issued)-Date.parse(e.issued))),a=["449868002","428041000124106","428071000124103","428061000124105","77176002"],o=["8517006","266919005"];for(let e=0;e<t.length;e+=1)if(("final"===t[e].status.toLowerCase()||"amended"===t[e].status.toLowerCase())&&t[e].valueCodeableConcept&&t[e].valueCodeableConcept.coding&&t[e].valueCodeableConcept.coding[0].code){if(a.indexOf(t[e].valueCodeableConcept.coding[0].code)>-1)return!0;if(o.indexOf(t[e].valueCodeableConcept.coding[0].code)>-1)return!1}};e.getCholesterolValue=t=>e.getFirstValidDataValue(t,(e=>"mg/dL"===e.valueQuantity.unit?parseFloat(e.valueQuantity.value):"mmol/L"===e.valueQuantity.unit?parseFloat(e.valueQuantity.value)/.026:void 0));e.getSystolicBloodPressureValue=t=>{const a=[];return t.forEach((e=>{const t=e.component.find((e=>e.code.coding.find((e=>"8480-6"===e.code))));if(t){const o=Object.assign({},e);o.valueQuantity=t.valueQuantity,a.push(o)}})),e.getFirstValidDataValue(Object.assign([],a),(e=>{if("mm[Hg]"===e.valueQuantity.unit||"mmHg"===e.valueQuantity.unit)return parseFloat(e.valueQuantity.value)}))};e.getFirstValidDataValue=(t,a)=>{const o=e.sortObservationsByTime(t);for(let t=0;t<o.length;t+=1)if(("final"===o[t].status.toLowerCase()||"amended"===o[t].status.toLowerCase())&&{}.hasOwnProperty.call(o[t],"valueQuantity")&&o[t].valueQuantity.value&&o[t].valueQuantity.unit){const r=a(o[t]);if(void 0!==r)return r;e.hasObservationWithUnsupportedUnits=!0,e.unsupportedUnitDataPoint=o[t]}else e.unsupportedObservationStructureDataPoint=o[t]};e.sortObservationsByTime=e=>(e.sort(((e,t)=>Date.parse(t.effectiveDateTime)-Date.parse(e.effectiveDateTime))),e);e.areRequiredLabsNotAvailable=()=>void 0===t.totalCholesterol||void 0===t.hdl||void 0===t.systolicBloodPressure;e.computeTenYearScore=e=>{if(e.age<40||e.age>79)return null;const t=Math.log(e.age),a=Math.log(e.totalCholesterol),o=Math.log(e.hdl),r=e.relatedFactors.hypertensive?Math.log(parseFloat(e.systolicBloodPressure)):0,i=e.relatedFactors.hypertensive?0:Math.log(parseFloat(e.systolicBloodPressure)),s=t*a,n=t*o,l=t*r,u=t*i,d=e.relatedFactors.smoker?t:0,c="aa"===e.relatedFactors.race,p="male"===e.gender;let h=0,v=0,g=0;return(()=>{c&&!p?(h=.95334,v=86.6081,g=17.1141*t+.9396*a+-18.9196*o+4.4748*n+29.2907*r+-6.4321*l+27.8197*i+-6.0873*u+.6908*Number(e.relatedFactors.smoker)+.8738*Number(e.relatedFactors.diabetic)):c||p?c&&p?(h=.89536,v=19.5425,g=2.469*t+.302*a+-.307*o+1.916*r+1.809*i+.549*Number(e.relatedFactors.smoker)+.645*Number(e.relatedFactors.diabetic)):(h=.91436,v=61.1816,g=12.344*t+11.853*a+-2.664*s+-7.99*o+1.769*n+1.797*r+1.764*i+7.837*Number(e.relatedFactors.smoker)+-1.795*d+.658*Number(e.relatedFactors.diabetic)):(h=.96652,v=-29.1817,g=-29.799*t+4.884*t**2+13.54*a+-3.114*s+-13.578*o+3.149*n+2.019*r+1.957*i+7.574*Number(e.relatedFactors.smoker)+-1.665*d+.661*Number(e.relatedFactors.diabetic));const m=1-h**Math.exp(g-v);return Math.round(100*m*10)/10})()};e.computeLifetimeRisk=e=>{if(e.age<20||e.age>59)return null;let t=0;const a={male:{major2:69,major1:50,elevated:46,notOptimal:36,allOptimal:5},female:{major2:50,major1:39,elevated:39,notOptimal:27,allOptimal:8}},o=(e.totalCholesterol>=240?1:0)+((e.systolicBloodPressure>=160?1:0)+(e.relatedFactors.hypertensive?1:0))+(e.relatedFactors.smoker?1:0)+(e.relatedFactors.diabetic?1:0),r=((e.totalCholesterol>=200&&e.totalCholesterol<240?1:0)+(e.systolicBloodPressure>=140&&e.systolicBloodPressure<160&&!1===e.relatedFactors.hypertensive?1:0)>=1?1:0)*(0===o?1:0),i=((e.totalCholesterol<180?1:0)+(e.systolicBloodPressure<120?1:0)*(e.relatedFactors.hypertensive?0:1)==2?1:0)*(0===o?1:0),s=((e.totalCholesterol>=180&&e.totalCholesterol<200?1:0)+(e.systolicBloodPressure>=120&&e.systolicBloodPressure<140&&!1===e.relatedFactors.hypertensive?1:0))*(0===r?1:0)*(0===o?1:0)>=1?1:0;return o>1&&(t=a[e.gender].major2),1===o&&(t=a[e.gender].major1),1===r&&(t=a[e.gender].elevated),1===s&&(t=a[e.gender].notOptimal),1===i&&(t=a[e.gender].allOptimal),t};e.computeLowestTenYear=()=>{const t=Object.assign({},e.patientInfo);t.systolicBloodPressure=90,t.totalCholesterol=130,t.hdl=100;const a=Object.assign({},e.patientInfo.relatedFactors);return a.diabetic=!1,a.smoker=!1,a.hypertensive=!1,t.relatedFactors=a,e.computeTenYearScore(t)};e.computeLowestLifetime=()=>{const t=Object.assign({},e.patientInfo);t.systolicBloodPressure=90,t.totalCholesterol=130,t.hdl=100;const a=Object.assign({},e.patientInfo.relatedFactors);return a.diabetic=!1,a.smoker=!1,a.hypertensive=!1,t.relatedFactors=a,e.computeLifetimeRisk(t)};e.computePotentialRisk=(t,a)=>{let o,r,i=0;"ten"===a?(o=e.computeTenYearScore(e.patientInfo),r=e.computeLowestTenYear()):(o=e.computeLifetimeRisk(e.patientInfo),r=e.computeLowestLifetime());for(let a=0;a<t.length;a+=1)if("statin"===t[a])i+=.25*o;else if("sysBP"===t[a]){i+=o-o*.7**((e.patientInfo.systolicBloodPressure-140)/10)}else"aspirin"===t[a]?i+=.1*o:"smoker"===t[a]&&(i+=.15*o);return Math.round(10*(o-i))/10<=r?Math.round(10*(o-r))/10:Math.round(10*i)/10};e.isValidAge=e=>!isNaN(e)&&void 0!==e&&e>=20&&e<=79;e.isValidSysBP=e=>!isNaN(e)&&void 0!==e&&e>=90&&e<=200;e.isValidHDL=e=>!isNaN(e)&&void 0!==e&&e>=20&&e<=100;e.isValidTotalCholesterol=e=>!isNaN(e)&&void 0!==e&&e>=130&&e<=320;e.canCalculateScore=()=>!!(e.isValidSysBP(e.patientInfo.systolicBloodPressure)&&e.isValidAge(e.patientInfo.age)&&e.isValidTotalCholesterol(e.patientInfo.totalCholesterol)&&e.isValidHDL(e.patientInfo.hdl)&&void 0!==e.patientInfo.relatedFactors.hypertensive&&void 0!==e.patientInfo.relatedFactors.race&&void 0!==e.patientInfo.relatedFactors.diabetic&&void 0!==e.patientInfo.relatedFactors.smoker&&void 0!==e.patientInfo.gender);e.missingFields=()=>{const t=[];return e.isValidTotalCholesterol(e.patientInfo.totalCholesterol)||t.push("formTotalCholesterol"),void 0===e.patientInfo.relatedFactors.diabetic&&t.push("formDiabetic"),e.isValidAge(e.patientInfo.age)||t.push("formAge"),e.isValidHDL(e.patientInfo.hdl)||t.push("formHdl"),void 0===e.patientInfo.relatedFactors.smoker&&t.push("formSmoker"),void 0===e.patientInfo.relatedFactors.race&&t.push("formRace"),e.isValidSysBP(e.patientInfo.systolicBloodPressure)||t.push("formSysBP"),void 0===e.patientInfo.relatedFactors.hypertensive&&t.push("formHypertensive"),void 0===e.patientInfo.gender&&t.push("formSex"),t},e.patientInfo=t,e.getBirthDateDisplay=function(){let t="";const a=e.patientInfo.dateOfBirth;return"[object Date]"!==Object.prototype.toString.call(a)||isNaN(a.getTime())||(t=`0${a.getDate()}`.slice(-2)+"/"+`0${a.getMonth()+1}`.slice(-2)+"/"+a.getFullYear()),t},e.display=function(t){e.patientInfo.birthDateDisplay=e.getBirthDateDisplay(),sessionStorage.setItem("ASCVDRisk.patientInfo",JSON.stringify(e.patientInfo)),apex.navigation.redirect("f?p="+apex.env.APP_ID+":"+t+":"+apex.env.APP_SESSION+":INIT")},window.ASCVDRisk=e})();